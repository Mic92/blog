<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.79.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:title" content="Automated Backups for Chef Server"><meta property="og:title" content="Automated Backups for Chef Server"><meta property="og:description" content="In this article I will share my setup, I use to backup chef server. In the best case, you have a dedicated machine, which has network access to your chef server. Otherwise you will have to additionally use a different backup program like rsnapshot or duplicity to backup the created export directory. In my case I use a raspberry pie with a hdd docking station and a power saving harddrive"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thalheim.io/2013/04/27/automated-backups-for-chef-server/"><meta property="article:published_time" content="2013-04-27T00:00:00+00:00"><meta property="article:modified_time" content="2013-04-27T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Automated Backups for Chef Server"><meta name=twitter:description content="In this article I will share my setup, I use to backup chef server. In the best case, you have a dedicated machine, which has network access to your chef server. Otherwise you will have to additionally use a different backup program like rsnapshot or duplicity to backup the created export directory. In my case I use a raspberry pie with a hdd docking station and a power saving harddrive"><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><title>Automated Backups for Chef Server | ~/git/blog</title><script data-goatcounter=https://goatcounter.thalheim.io/count async src=https://goatcounter.thalheim.io/count.js></script></head><body><header><div id=titletext><h2 id=title><a href=https://blog.thalheim.io/>~/git/blog</a></h2></div><div id=title-description><p id=subtitle>My brain-dump of random code/configuration.</p><div id=social><nav><ul><li><a href=/index.html><i title=RSS class="icons fas fa-rss"></i></a></li><li><a href=https://github.com/Mic92/blog><i title=Github class="icons fab fa-github"></i></a></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/>Home</a></li><li><a href=/post>All Posts</a></li><li><a href=/categories>Categories</a></li></ul></nav></div></header><main><div class=post><div class=author></div><div class=post-header><div class=meta><div class=date><span class=day>27</span>
<span class=rest>Apr 2013</span></div></div><div class=matter><h1 class=title>Automated Backups for Chef Server</h1></div></div><div class=markdown><p>In this article I will share my setup, I use to backup chef server.
In the best case, you have a dedicated machine, which has network access to your chef
server. Otherwise you will have to additionally use a different backup program
like <a href=http://www.rsnapshot.org/ target=_blank>rsnapshot</a> or
<a href=http://duplicity.nongnu.org/ target=_blank>duplicity</a> to backup the created export
directory. In my case I use a raspberry pie with a
<a href="http://www.amazon.de/dp/B0017J4IAQ?tag=gitblo-21" target=_blank>hdd docking station</a> and a
<a href="http://www.amazon.de/dp/B004VFJ9MK?tag=gitblo-21" target=_blank>power saving harddrive</a></p><p>To get started you will need ruby on the backup machine. I prefer using rvm for
this job. Feel free to choose your preferred way:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ curl -L https://get.rvm.io | bash -s stable --autolibs=enabled
</code></pre></div><p>To create the backup, I use the great <a href=https://github.com/mdxp/knife-backup target=_blank>knife-backup gem</a> of <a href=http://www.ducea.com/ target=_blank>Marius Ducea</a>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ gem install knife-backup
</code></pre></div><p>Then add these scripts to your system:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ mkdir -p ~/bin &amp;&amp; cd ~/bin
$ wget http://blog.higgsboson.tk/downloads/code/chef-backup/backup-chef.sh
$ wget http://blog.higgsboson.tk/downloads/code/chef-backup/restore-chef.sh
$ chmod +x {backup,restore}-chef.sh
</code></pre></div><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#999;font-weight:700;font-style:italic>#!/bin/bash
</span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#998;font-style:italic># optional: load rvm</span>
<span style=color:#0086b3>source</span> <span style=color:#d14>&#34;</span><span style=color:teal>$HOME</span><span style=color:#d14>/.rvm/scripts/rvm&#34;</span> <span style=color:#000;font-weight:700>||</span> <span style=color:#0086b3>source</span> <span style=color:#d14>&#34;/usr/local/rvm/scripts/rvm&#34;</span>

<span style=color:#0086b3>cd</span> /tmp

<span style=color:teal>BACKUP</span><span style=color:#000;font-weight:700>=</span>/path/to/your/backup <span style=color:#998;font-style:italic>#&amp;lt;--- EDIT THIS LINE</span>
<span style=color:teal>TMPDIR</span><span style=color:#000;font-weight:700>=</span>/tmp/<span style=color:#000;font-weight:700>$(</span>mktemp -d chef-backup-XXXX<span style=color:#000;font-weight:700>)</span>
<span style=color:teal>MAX_BACKUPS</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>8</span>

<span style=color:#0086b3>cd</span> <span style=color:teal>$TMPDIR</span>
<span style=color:#0086b3>trap</span> <span style=color:#d14>&#34;rm -rf &#39;</span><span style=color:teal>$TMPDIR</span><span style=color:#d14>&#39;&#34;</span> INT QUIT TERM EXIT
knife --config <span style=color:teal>$HOME</span>/.chef/knife-backup.rb backup <span style=color:#0086b3>export</span> -D . &amp;gt;/dev/null
tar -cjf <span style=color:#d14>&#34;</span><span style=color:teal>$BACKUP</span><span style=color:#d14>/</span><span style=color:#000;font-weight:700>$(</span>date +%m.%d.%Y<span style=color:#000;font-weight:700>)</span><span style=color:#d14>.tar.bz2&#34;</span> .
<span style=color:#998;font-style:italic># keep the last X backups</span>
ls -t <span style=color:#d14>&#34;</span><span style=color:teal>$BACKUP</span><span style=color:#d14>&#34;</span> | tail -n+<span style=color:teal>$MAX_BACKUPS</span> | xargs rm -f
</code></pre></div><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#999;font-weight:700;font-style:italic>#!/bin/bash
</span><span style=color:#999;font-weight:700;font-style:italic></span>
<span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#d14>&#34;</span><span style=color:teal>$#</span><span style=color:#d14>&#34;</span> -eq <span style=color:#099>0</span> <span style=color:#000;font-weight:700>]</span>; <span style=color:#000;font-weight:700>then</span>
    <span style=color:#0086b3>echo</span> <span style=color:#d14>&#34;USAGE: </span><span style=color:teal>$0</span><span style=color:#d14> /path/to/backup&#34;</span>
    <span style=color:#0086b3>exit</span> <span style=color:#099>1</span>
<span style=color:#000;font-weight:700>fi</span>

<span style=color:#0086b3>source</span> <span style=color:#d14>&#34;</span><span style=color:teal>$HOME</span><span style=color:#d14>/.rvm/scripts/rvm&#34;</span> <span style=color:#000;font-weight:700>||</span> <span style=color:#0086b3>source</span> <span style=color:#d14>&#34;/usr/local/rvm/scripts/rvm&#34;</span>

<span style=color:#0086b3>cd</span> /tmp
<span style=color:teal>TMPDIR</span><span style=color:#000;font-weight:700>=</span>/tmp/<span style=color:#000;font-weight:700>$(</span>mktemp -d chef-restore-XXXX<span style=color:#000;font-weight:700>)</span>

<span style=color:#0086b3>cd</span> <span style=color:#d14>&#34;</span><span style=color:teal>$TMPDIR</span><span style=color:#d14>&#34;</span>
<span style=color:#0086b3>trap</span> <span style=color:#d14>&#34;rm -rf &#39;</span><span style=color:teal>$TMPDIR</span><span style=color:#d14>&#39;&#34;</span> INT QUIT TERM EXIT
tar xf <span style=color:teal>$1</span>
knife --config <span style=color:teal>$HOME</span>/.chef/knife-backup.rb backup restore -D .
</code></pre></div><p>Modify BACKUP variable to match your backup destination.
Next you will need a knife.rb to get access to your server.
I suggest to create a new client:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ mkdir -p ~/.chef
$ knife client create backup --admin --file &#34;$HOME/.chef/backup.pem&#34;
$ cat &lt;&lt;&#39;__EOF__&#39; &gt;&gt; ~/.chef/knife-backup.rb
log_level                :info
log_location             STDOUT
node_name                &#39;backup&#39;
client_key               &#34;#{ENV[&#34;HOME&#34;]}/.chef/backup.pem&#34;
chef_server_url          &#39;https://chef.yourdomain.tld&#39; # EDIT HERE
syntax_check_cache_path  &#34;#{ENV[&#34;HOME&#34;]}.chef/syntax_check_cache&#34;
__EOF__
$ knife role list # test authentication
</code></pre></div><p>Now test the whole setup, by running the <code>backup-chef.sh</code> script:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ ~/bin/backup-chef.sh
</code></pre></div><p>It should create a tar file in the backup directory.</p><p>If everything works, you can add a cronjob to automate this.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ crontab -e
</code></pre></div><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>@daily $HOME/bin/backup-chef.sh
</code></pre></div><p>To restore a backup simply run (where <code>DATE</code> is the date of the backup)</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ ~/bin/restore-chef.sh /path/to/backup/DATE.tar.bz2
</code></pre></div><p>That&rsquo;s all folks!</p></div><div class=tags><div class=taxosfloating_left><p>Categories</p></div><div class=termsfloating_right><p><a href=/categories/backup/>backup</a>
<a href=/categories/chef/>chef</a>
<a href=/categories/cron/>cron</a>
<a href=/categories/knife-backup/>knife-backup</a>
<a href=/categories/opscode/>opscode</a></p></div><div class=clearit></div></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"mic92"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer>© 2021 Jörg Thalheim</footer></body></html>