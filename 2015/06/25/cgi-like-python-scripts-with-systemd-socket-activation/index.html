<!doctype html><html lang=en><head><meta charset=utf-8><title>Cgi Like Python Scripts With Systemd Socket Activation | ~/git/blog</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><script data-goatcounter=https://goatcounter.thalheim.io/count async src=https://goatcounter.thalheim.io/count.js></script><meta property="og:title" content="Cgi Like Python Scripts With Systemd Socket Activation"><meta property="og:description" content="Lets say you want to trigger remote the start of a python script. But you don&rsquo;t want to have a service running all the time waiting for requests.
What you can do, is using socket-unit in systemd, which is waiting on a tcp port for connections and starts the service, if somebody is requesting it.
The systemd configuration could look like this:
Listens on tcp port 3000 (both ipv4 and ipv6) Execute python script as user &rsquo;nobody&rsquo; with a timeout of 5 minutes [Unit] Description=Start update on demand [Socket] ListenStream=3000 # only listen on localhost #ListenStream=127."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thalheim.io/2015/06/25/cgi-like-python-scripts-with-systemd-socket-activation/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-06-25T00:00:00+00:00"><meta property="article:modified_time" content="2015-06-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Cgi Like Python Scripts With Systemd Socket Activation"><meta name=twitter:description content="Lets say you want to trigger remote the start of a python script. But you don&rsquo;t want to have a service running all the time waiting for requests.
What you can do, is using socket-unit in systemd, which is waiting on a tcp port for connections and starts the service, if somebody is requesting it.
The systemd configuration could look like this:
Listens on tcp port 3000 (both ipv4 and ipv6) Execute python script as user &rsquo;nobody&rsquo; with a timeout of 5 minutes [Unit] Description=Start update on demand [Socket] ListenStream=3000 # only listen on localhost #ListenStream=127."><meta itemprop=name content="Cgi Like Python Scripts With Systemd Socket Activation"><meta itemprop=description content="Lets say you want to trigger remote the start of a python script. But you don&rsquo;t want to have a service running all the time waiting for requests.
What you can do, is using socket-unit in systemd, which is waiting on a tcp port for connections and starts the service, if somebody is requesting it.
The systemd configuration could look like this:
Listens on tcp port 3000 (both ipv4 and ipv6) Execute python script as user &rsquo;nobody&rsquo; with a timeout of 5 minutes [Unit] Description=Start update on demand [Socket] ListenStream=3000 # only listen on localhost #ListenStream=127."><meta itemprop=datePublished content="2015-06-25T00:00:00+00:00"><meta itemprop=dateModified content="2015-06-25T00:00:00+00:00"><meta itemprop=wordCount content="264"><meta itemprop=keywords content></head><body><header><div id=titletext><h2 id=title><a href=https://blog.thalheim.io/>~/git/blog</a></h2></div><div id=title-description><p id=subtitle>My brain-dump of random code/configuration.</p><div id=social><nav><ul><li><a href=/index.xml rel=me aria-label=RSS><span title=RSS class="icons fas fa-rss" aria-hidden=true></span></a></li><li><a href=https://github.com/Mic92/blog rel=me aria-label=Github><span title=Github class="icons fab fa-github" aria-hidden=true></span></a></li><li><button id=dark-mode aria-label="Switch Dark Mode"><span title="Switch Dark Mode" class="icons fas fa-moon" aria-hidden=true></span></button></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/categories>Categories</a></li></ul></nav></div></header><main><div class=post><article><div class=post-header><div class=meta><div class=date><span class=day>25</span>
<span class=rest>Jun 2015</span></div></div><div class=matter><h1 class=title>Cgi Like Python Scripts With Systemd Socket Activation</h1><p class=post-meta><span class=post-meta></span></p></div></div><div class=markdown><p>Lets say you want to trigger remote the start of a python script. But you don&rsquo;t
want to have a service running all the time waiting for requests.</p><p>What you can do, is using socket-unit in systemd, which is waiting on a tcp port
for connections and starts the service, if somebody is requesting it.</p><p>The systemd configuration could look like this:</p><ul><li>Listens on tcp port 3000 (both ipv4 and ipv6)</li><li>Execute python script as user &rsquo;nobody&rsquo; with a timeout of 5 minutes</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#ff79c6>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>Description</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>Start update on demand</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[Socket]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>ListenStream</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>3000</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># only listen on localhost</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#ListenStream=127.0.0.1:3000</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>BindIPv6Only</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>both</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>WantedBy</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>multi-user.target</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#ff79c6>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>Description</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>Start update on demand</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>JobTimeoutSec</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>5min</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>User</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>nobody</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>ExecStart</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>/usr/bin/python /path/to/script.py</span>
</span></span></code></pre></div><p>In your python code, do the following</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>systemd_socket_response</span>():
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    Accepts every connection of the listen socket provided by systemd, send the
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    HTTP Response &#39;OK&#39; back.
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>from</span> systemd.daemon <span style=color:#ff79c6>import</span> listen_fds;
</span></span><span style=display:flex><span>        fds <span style=color:#ff79c6>=</span> listen_fds()
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>except</span> ImportError:
</span></span><span style=display:flex><span>        fds <span style=color:#ff79c6>=</span> [<span style=color:#bd93f9>3</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> fd <span style=color:#ff79c6>in</span> fds:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>import</span> socket
</span></span><span style=display:flex><span>        sock <span style=color:#ff79c6>=</span> socket<span style=color:#ff79c6>.</span>fromfd(fd, socket<span style=color:#ff79c6>.</span>AF_INET, socket<span style=color:#ff79c6>.</span>SOCK_STREAM)
</span></span><span style=display:flex><span>        sock<span style=color:#ff79c6>.</span>settimeout(<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>True</span>:
</span></span><span style=display:flex><span>              conn, addr <span style=color:#ff79c6>=</span> sock<span style=color:#ff79c6>.</span>accept()
</span></span><span style=display:flex><span>              conn<span style=color:#ff79c6>.</span>sendall(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;HTTP/1.1 200 OK</span><span style=color:#f1fa8c>\r\n</span><span style=color:#f1fa8c>Content-Type: text/plain</span><span style=color:#f1fa8c>\r\n</span><span style=color:#f1fa8c>Content-Length: 3</span><span style=color:#f1fa8c>\r\n\r\n</span><span style=color:#f1fa8c>OK</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>except</span> socket<span style=color:#ff79c6>.</span>timeout:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>pass</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>except</span> OSError <span style=color:#ff79c6>as</span> e:
</span></span><span style=display:flex><span>            <span style=color:#6272a4># Connection closed again? Don&#39;t care, we just do our job.</span>
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(e)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> __name__ <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> os<span style=color:#ff79c6>.</span>environ<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;LISTEN_FDS&#34;</span>, <span style=color:#ff79c6>None</span>) <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>None</span>:
</span></span><span style=display:flex><span>        systemd_socket_response()
</span></span><span style=display:flex><span>   <span style=color:#6272a4># here your own code begins</span>
</span></span><span style=display:flex><span>   do_work()
</span></span></code></pre></div><p>This still lacks of authentication and does not take any arguments. You could
protect this port using a frontend webserver with http authentication, or you
pass the listen socket to an python http server, which add some token passed
authentication. Systemd will ensure, that your service will not run more than
once at the time.</p></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mic92.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div></main><footer>© 2021 Jörg Thalheim</footer><script src=/js/dark-mode.js></script></body></html>