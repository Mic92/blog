<!doctype html><html lang=en><head><meta charset=utf-8><title>Cross compiling and deploying NixOS | ~/git/blog</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jörg Thalheim and Alex A. Renoire"><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><script data-goatcounter=https://goatcounter.thalheim.io/count async src=https://goatcounter.thalheim.io/count.js></script><meta property="og:title" content="Cross compiling and deploying NixOS"><meta property="og:description" content="Background Last week I was setting up this RISCv-based HiFive Unmatched board[1] with NixOS. Thanks to zhaofengli this was actually pretty straight forward given that his repository contained a full walk-through, images and a binary cache. So instead of spending the NixOS Munich Meetup hacking on this architecture, I had time to go further.
One of the thing that becomes quickly apparent while hacking on the board is that although the board is quite beefy with 16GB of RAM and NVME, it cannot keep up with up-to-date x86 machines."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thalheim.io/2022/11/27/cross-compiling-and-deploying-nixos/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-27T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-27T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Cross compiling and deploying NixOS"><meta name=twitter:description content="Background Last week I was setting up this RISCv-based HiFive Unmatched board[1] with NixOS. Thanks to zhaofengli this was actually pretty straight forward given that his repository contained a full walk-through, images and a binary cache. So instead of spending the NixOS Munich Meetup hacking on this architecture, I had time to go further.
One of the thing that becomes quickly apparent while hacking on the board is that although the board is quite beefy with 16GB of RAM and NVME, it cannot keep up with up-to-date x86 machines."><meta itemprop=name content="Cross compiling and deploying NixOS"><meta itemprop=description content="Background Last week I was setting up this RISCv-based HiFive Unmatched board[1] with NixOS. Thanks to zhaofengli this was actually pretty straight forward given that his repository contained a full walk-through, images and a binary cache. So instead of spending the NixOS Munich Meetup hacking on this architecture, I had time to go further.
One of the thing that becomes quickly apparent while hacking on the board is that although the board is quite beefy with 16GB of RAM and NVME, it cannot keep up with up-to-date x86 machines."><meta itemprop=datePublished content="2022-11-27T00:00:00+00:00"><meta itemprop=dateModified content="2022-11-27T00:00:00+00:00"><meta itemprop=wordCount content="560"><meta itemprop=keywords content></head><body><header><div id=titletext><h2 id=title><a href=https://blog.thalheim.io/>~/git/blog</a></h2></div><div id=title-description><p id=subtitle>My brain-dump of random code/configuration.</p><div id=social><nav><ul><li><a href=/index.xml rel=me aria-label=RSS><span title=RSS class="icons fas fa-rss" aria-hidden=true></span></a></li><li><a href=https://github.com/Mic92/blog rel=me aria-label=Github><span title=Github class="icons fab fa-github" aria-hidden=true></span></a></li><li><button id=dark-mode aria-label="Switch Dark Mode"><span title="Switch Dark Mode" class="icons fas fa-moon" aria-hidden=true></span></button></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/categories>Categories</a></li></ul></nav></div></header><main><div class=post><article><div class=post-header><div class=meta><div class=date><span class=day>27</span>
<span class=rest>Nov 2022</span></div></div><div class=matter><h1 class=title>Cross compiling and deploying NixOS</h1><p class=post-meta><span class=post-meta><span aria-label=Author:><span class="fas fa-user" aria-hidden=true></span></span>&nbsp;
Jörg Thalheim and Alex A. Renoire</span></p></div></div><div class=markdown><h2 id=background>Background</h2><p>Last week I was setting up this RISCv-based HiFive Unmatched board[1] with
NixOS. Thanks to <a href=https://github.com/zhaofengli target=_blank>zhaofengli</a> this was actually
pretty straight forward given that his
<a href=https://github.com/zhaofengli/nixos-riscv64 target=_blank>repository</a> contained a full
walk-through, images and a binary cache. So instead of spending the
<a href=https://www.meetup.com/Munich-NixOS-Meetup/ target=_blank>NixOS Munich Meetup</a> hacking on
this architecture, I had time to go further.</p><p>One of the thing that becomes quickly apparent while hacking on the board is
that although the board is quite beefy with 16GB of RAM and NVME, it cannot keep
up with up-to-date x86 machines. This is where cross-compiling NixOS helps.</p><h2 id=goal-of-this-article>Goal of this article</h2><p>In this article I will show you how to use NixOS on a host x86_64 machine to
debug and cross-deploy another NixOS machine. And iterate faster doing so.</p><p>We&rsquo;re going to do this with the following steps:</p><ol><li>How to define a cross-compiled nixos configuration in flakes</li><li>How to deploy from cross-compile nixos machine</li><li>Work-around cross-compiling issues with binfmt</li></ol><h2 id=configuring-the-flake>Configuring the flake</h2><p>First we need to find out the architecture we want to build on and the
architecture to build for. The easiest way to find out is using <code>nix repl</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#555>$</span> nix repl <span style=color:#d14>&#39;&lt;nixpkgs&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#888>repl&gt; pkgs.system # This is our build architecture
</span></span></span><span style=display:flex><span><span style=color:#888>&#34;x86_64-linux&#34;
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#555>#</span> use tab completion to find the architecture you want to build <span style=color:#000;font-weight:700>for</span>
</span></span><span style=display:flex><span><span style=color:#888>repl&gt; pkgsCross.&lt;TAB&gt;
</span></span></span></code></pre></div><p>We are interested in <code>pkgsCross.&lt;arch>.system</code> here. For my board this looks
like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>repl&gt; pkgsCross.riscv64.system
</span></span></span><span style=display:flex><span><span style=color:#888>&#34;riscv64-linux&#34;
</span></span></span></code></pre></div><p>With information we can define the cross-compiled variant of our nixos machine:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  inputs<span style=color:#000;font-weight:700>.</span>nixpkgs<span style=color:#000;font-weight:700>.</span>url <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;github:NixOS/nixpkgs/release-22.11&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#000;font-weight:700>=</span> { self<span style=color:#000;font-weight:700>,</span> nixpkgs }: {
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#000;font-weight:700>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic># Native machine build</span>
</span></span><span style=display:flex><span>      my-nixos <span style=color:#000;font-weight:700>=</span> nixpkgs<span style=color:#000;font-weight:700>.</span>lib<span style=color:#000;font-weight:700>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;riscv64-linux&#34;</span>;
</span></span><span style=display:flex><span>        modules <span style=color:#000;font-weight:700>=</span> [ <span style=color:#009926>./configuration.nix</span> ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic># Cross machine build, from x86_64</span>
</span></span><span style=display:flex><span>      my-nixos-from-x86_64 <span style=color:#000;font-weight:700>=</span> nixpkgs<span style=color:#000;font-weight:700>.</span>lib<span style=color:#000;font-weight:700>.</span>nixosSystem {
</span></span><span style=display:flex><span>        modules <span style=color:#000;font-weight:700>=</span> [
</span></span><span style=display:flex><span>          <span style=color:#009926>./configuration.nix</span>
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#998;font-style:italic># This is the architecture we build from (pkgs.system from above)</span>
</span></span><span style=display:flex><span>            nixpkgs<span style=color:#000;font-weight:700>.</span>buildPlatform <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#998;font-style:italic># pkgsCross.&lt;yourtarget&gt;.system</span>
</span></span><span style=display:flex><span>            nixpkgs<span style=color:#000;font-weight:700>.</span>hostPlatform <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;riscv64-linux&#34;</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=deploying-to-the-board>Deploying to the board</h2><p>Now that we have this extended flake configuration, deploying the new system
closures to the board becomes easy:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#555>$</span> nixos-rebuild switch <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span><span style=color:#888>  --fast \
</span></span></span><span style=display:flex><span><span style=color:#888>  --build-host localhost \
</span></span></span><span style=display:flex><span><span style=color:#888>  --target-host $target_host \
</span></span></span><span style=display:flex><span><span style=color:#888>  --flake .#my-nixos-from-x86_64
</span></span></span></code></pre></div><p>nixos-rebuild will (1) build the system on the host machine, and then (2) copy
the build result onto the board, and finally (3) atomically switch the
configuration. The <code>--fast</code> flag here is crucial since it stops <code>nixos-rebuild</code>
from using the riscv build of nix on the x86_64 machine.</p><h2 id=bonus-work-around-cross-compiling-issues-with-binfmt>(Bonus) Work-around cross-compiling issues with binfmt</h2><p>While many packages cross-compile out-of-the box a few packages are not aware of
cross compiling and try to execute binaries they just have built on the same
machine. Since it sometimes not feasiable to fix this issues easily, one trick
is to set platform emulation support based binfmt_misc and qemu. This allows to
run the binaries directly on the NixOS host that are actually compiled for a
different architecture.</p><p>It also allows to test and run binaries without having to copy them over to the
target machine.</p><p>In order to do that, extend the host NixOS configuration</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  boot<span style=color:#000;font-weight:700>.</span>binfmt<span style=color:#000;font-weight:700>.</span>emulatedSystems <span style=color:#000;font-weight:700>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#d14>&#34;riscv64-linux&#34;</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Cross-compiling has made good progress over the years. While still not a
first-class citizen in nixpkgs is now in a usable state for deploying nixos
systems. This helps a lot to get NixOS on little computers and port Nix to new
architecture are not covered by official hydra builds.</p></div><div class=tags><div class=taxosfloating_left><p>Categories</p></div><div class=termsfloating_right><p><a href=/categories/compiling/>compiling</a>
<a href=/categories/cross/>cross</a>
<a href=/categories/nix/>nix</a></p></div><div class=clearit></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mic92.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div></main><footer>© 2021 Jörg Thalheim</footer><script src=/js/dark-mode.js></script></body></html>