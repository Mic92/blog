<!doctype html><html lang=en><head><meta charset=utf-8><title>ZFS ate my RAM: Understanding the ARC cache | ~/git/blog</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jörg Thalheim"><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><script data-goatcounter=https://goatcounter.thalheim.io/count async src=https://goatcounter.thalheim.io/count.js></script><meta property="og:title" content="ZFS ate my RAM: Understanding the ARC cache"><meta property="og:description" content="If you&rsquo;re running ZFS on Linux and checking your system&rsquo;s memory usage, you might be shocked to see that most of your RAM appears to be consumed. Don&rsquo;t panic! This is actually by design, and it&rsquo;s a good thing.
The confusion When you run free -h, you might see something like this:
$ free -h total used free shared buff/cache available Mem: 31Gi 28Gi 512Mi 128Mi 2.5Gi 2.8Gi Swap: 8.0Gi 1."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thalheim.io/2025/10/17/zfs-ate-my-ram-understanding-the-arc-cache/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-17T11:36:00+00:00"><meta property="article:modified_time" content="2025-10-17T11:36:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ZFS ate my RAM: Understanding the ARC cache"><meta name=twitter:description content="If you&rsquo;re running ZFS on Linux and checking your system&rsquo;s memory usage, you might be shocked to see that most of your RAM appears to be consumed. Don&rsquo;t panic! This is actually by design, and it&rsquo;s a good thing.
The confusion When you run free -h, you might see something like this:
$ free -h total used free shared buff/cache available Mem: 31Gi 28Gi 512Mi 128Mi 2.5Gi 2.8Gi Swap: 8.0Gi 1."><meta itemprop=name content="ZFS ate my RAM: Understanding the ARC cache"><meta itemprop=description content="If you&rsquo;re running ZFS on Linux and checking your system&rsquo;s memory usage, you might be shocked to see that most of your RAM appears to be consumed. Don&rsquo;t panic! This is actually by design, and it&rsquo;s a good thing.
The confusion When you run free -h, you might see something like this:
$ free -h total used free shared buff/cache available Mem: 31Gi 28Gi 512Mi 128Mi 2.5Gi 2.8Gi Swap: 8.0Gi 1."><meta itemprop=datePublished content="2025-10-17T11:36:00+00:00"><meta itemprop=dateModified content="2025-10-17T11:36:00+00:00"><meta itemprop=wordCount content="747"><meta itemprop=keywords content></head><body><header><div id=titletext><h2 id=title><a href=https://blog.thalheim.io/>~/git/blog</a></h2></div><div id=title-description><p id=subtitle>My brain-dump of random code/configuration.</p><div id=social><nav><ul><li><a href=/index.xml rel=me aria-label=RSS><span title=RSS class="icons fas fa-rss" aria-hidden=true></span></a></li><li><a href=https://github.com/Mic92/blog rel=me aria-label=Github><span title=Github class="icons fab fa-github" aria-hidden=true></span></a></li><li><button id=dark-mode aria-label="Switch Dark Mode"><span title="Switch Dark Mode" class="icons fas fa-moon" aria-hidden=true></span></button></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/categories>Categories</a></li></ul></nav></div></header><main><div class=post><article><div class=post-header><div class=meta><div class=date><span class=day>17</span>
<span class=rest>Oct 2025</span></div></div><div class=matter><h1 class=title>ZFS ate my RAM: Understanding the ARC cache</h1><p class=post-meta><span class=post-meta><span aria-label=Author:><span class="fas fa-user" aria-hidden=true></span></span>&nbsp;
Jörg Thalheim</span></p></div></div><div class=markdown><p>If you&rsquo;re running ZFS on Linux and checking your system&rsquo;s memory usage, you
might be shocked to see that most of your RAM appears to be consumed. Don&rsquo;t
panic! This is actually by design, and it&rsquo;s a good thing.</p><h2 id=the-confusion>The confusion</h2><p>When you run <code>free -h</code>, you might see something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ free -h
</span></span><span style=display:flex><span><span style=color:#44475a>              total        used        free      shared  buff/cache   available
</span></span></span><span style=display:flex><span><span style=color:#44475a>Mem:           31Gi        28Gi       512Mi       128Mi       2.5Gi       2.8Gi
</span></span></span><span style=display:flex><span><span style=color:#44475a>Swap:         8.0Gi       1.2Gi       6.8Gi
</span></span></span></code></pre></div><p>It looks like your system is using 28GB out of 31GB! But before you start
hunting for memory leaks, you need to understand how ZFS works.</p><h2 id=what-is-the-arc>What is the ARC?</h2><p>ZFS uses an <strong>Adaptive Replacement Cache (ARC)</strong> to store frequently accessed
data in RAM. This cache dramatically improves read performance by keeping hot
data in memory instead of repeatedly reading from disk.</p><p>The key thing to understand is: <strong>ZFS is supposed to use most of your available
RAM for the ARC</strong>. It&rsquo;s not a memory leak; it&rsquo;s a feature!</p><p>The ARC behaves similarly to the Linux page cache (what you might know from
<a href=https://www.linuxatemyram.com/ target=_blank>linuxatemyram.com</a>), but with some important
differences:</p><ul><li>The ARC is managed by ZFS itself, not the kernel</li><li>It can store compressed data, making it even more efficient</li><li>It includes metadata caching for faster file operations</li><li>It has sophisticated algorithms to keep the most useful data cached</li></ul><h2 id=how-to-check-actual-memory-pressure>How to check actual memory pressure</h2><p>The memory shown as &ldquo;used&rdquo; includes the ARC, which is <strong>reclaimable</strong>. When
applications need memory, ZFS will shrink the ARC to make room.</p><h3 id=check-zfs-arc-usage>Check ZFS ARC usage</h3><p>To see how much RAM the ARC is actually using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cat /proc/spl/kstat/zfs/arcstats | grep <span style=color:#f1fa8c>&#34;^size&#34;</span> | head -1
</span></span><span style=display:flex><span><span style=color:#44475a>size                            4    26843545600
</span></span></span></code></pre></div><p>The second number is in bytes. To make it human-readable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ awk <span style=color:#f1fa8c>&#39;/^size/ { printf &#34;ARC size: %.2f GB\n&#34;, $3/1024/1024/1024; exit }&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span><span style=color:#44475a>  /proc/spl/kstat/zfs/arcstats
</span></span></span><span style=display:flex><span><span style=color:#44475a>ARC size: 25.00 GB
</span></span></span></code></pre></div><p>Or use the <code>arc_summary</code> tool if available:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ arc_summary | head -20
</span></span></code></pre></div><h3 id=check-actual-available-memory>Check actual available memory</h3><p>The &ldquo;available&rdquo; column in <code>free</code> already accounts for reclaimable memory,
including some of the ARC. So in our earlier example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ free -h
</span></span><span style=display:flex><span><span style=color:#44475a>              total        used        free      shared  buff/cache   available
</span></span></span><span style=display:flex><span><span style=color:#44475a>Mem:           31Gi        28Gi       512Mi       128Mi       2.5Gi       2.8Gi
</span></span></span></code></pre></div><p>The <strong>2.8Gi available</strong> is what actually matters. This is the memory that can be
immediately used by applications without swapping. If this number gets low, then
you might have actual memory pressure.</p><h3 id=monitor-arc-efficiency>Monitor ARC efficiency</h3><p>Check if the ARC is actually helping performance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ awk &#39;/^hits/ <span style=color:#ff79c6>{</span> <span style=color:#8be9fd;font-style:italic>hits</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$3</span> <span style=color:#ff79c6>}</span> /^misses/ <span style=color:#ff79c6>{</span> <span style=color:#8be9fd;font-style:italic>misses</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$3</span> <span style=color:#ff79c6>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span><span style=color:#44475a>  END { printf &#34;Hit rate: %.2f%%\n&#34;, hits*100/(hits+misses) }&#39; \
</span></span></span><span style=display:flex><span><span style=color:#44475a>  /proc/spl/kstat/zfs/arcstats
</span></span></span><span style=display:flex><span><span style=color:#44475a>Hit rate: 94.23%
</span></span></span></code></pre></div><p>A high hit rate (above 80-90%) means the ARC is doing its job well.</p><h2 id=tuning-the-arc>Tuning the ARC</h2><h3 id=set-maximum-arc-size>Set maximum ARC size</h3><p>If you really want to limit the ARC (for example, if you&rsquo;re running memory-heavy
applications), you can set a maximum size.</p><p>Add to <code>/etc/modprobe.d/zfs.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>options zfs zfs_arc_max=17179869184
</span></span></code></pre></div><p>This limits the ARC to 16GB (value is in bytes). Apply with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#bd93f9>17179869184</span> &gt; /sys/module/zfs/parameters/zfs_arc_max
</span></span></code></pre></div><p>Or reboot for the modprobe setting to take effect.</p><h3 id=set-minimum-arc-size>Set minimum ARC size</h3><p>You can also set a minimum to ensure ZFS always has some cache:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>options zfs zfs_arc_min=4294967296
</span></span></code></pre></div><p>This ensures at least 4GB is always reserved for the ARC.</p><h2 id=best-practices>Best practices</h2><ol><li><p><strong>Don&rsquo;t limit the ARC unless necessary</strong>: ZFS is designed to use available
memory efficiently. The default behavior is usually optimal.</p></li><li><p><strong>Monitor the &ldquo;available&rdquo; memory</strong>: This is your real indicator of memory
pressure, not &ldquo;used&rdquo; memory.</p></li><li><p><strong>Watch for swap usage</strong>: If your system starts swapping while the ARC is
large, you might need to limit the ARC size.</p></li><li><p><strong>Use <code>htop</code> or similar tools</strong>: They often show memory usage in a more
intuitive way, with better breakdowns of cache vs. active memory.</p></li><li><p><strong>Check ARC hit rate</strong>: If your hit rate is low, you might benefit from more
RAM or need to optimize your workload.</p></li></ol><h2 id=the-bottom-line>The bottom line</h2><p>Just like the page cache in Linux, <strong>ZFS using most of your RAM is normal and
beneficial</strong>. The ARC makes your file system faster by caching data in memory.</p><p>Remember:</p><ul><li><strong>High &ldquo;used&rdquo; memory</strong>: Normal, includes ARC cache</li><li><strong>Low &ldquo;available&rdquo; memory</strong>: This is when you should worry</li><li><strong>The ARC shrinks automatically</strong>: When applications need memory, ZFS gives it
back</li></ul><p>So next time you see <code>free</code> showing high memory usage on a ZFS system, take a
deep breath and check the &ldquo;available&rdquo; column instead. Your RAM isn&rsquo;t being
eaten—it&rsquo;s being put to good use!</p><h2 id=further-reading>Further reading</h2><ul><li><a href=https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Module%20Parameters.html#arc target=_blank>ZFS on Linux ARC documentation</a></li><li><a href=https://www.linuxatemyram.com/ target=_blank>Linux ate my RAM</a> - Understanding general Linux memory usage</li><li><a href=https://wiki.freebsd.org/ZFSTuningGuide#ARC target=_blank>OpenZFS ARC tuning guide</a></li></ul></div><div class=tags><div class=taxosfloating_left><p>Categories</p></div><div class=termsfloating_right><p><a href=/categories/linux/>linux</a>
<a href=/categories/memory/>memory</a>
<a href=/categories/zfs/>zfs</a></p></div><div class=clearit></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mic92.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div></main><footer>© 2021 Jörg Thalheim</footer><script src=/js/dark-mode.js></script></body></html>