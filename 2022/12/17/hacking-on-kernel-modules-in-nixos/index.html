<!doctype html><html lang=en><head><meta charset=utf-8><title>Hacking on Kernel Modules in NixOS | ~/git/blog</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jörg Thalheim and Alex A. Renoire"><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><script data-goatcounter=https://goatcounter.thalheim.io/count async src=https://goatcounter.thalheim.io/count.js></script><meta property="og:title" content="Hacking on Kernel Modules in NixOS"><meta property="og:description" content="Lately, I hacked on some kernel modules to get more debug logs out of a kernel module on my NixOS machine. Because NixOS does not follow the Filesystem Hierarchy Standard (FHS) for filesystem layouts, the standard kernel hacker tutorials won&rsquo;t fully apply to NixOS. However, by leveraging the NixOS configuration, we can quickly set up an environment that allows us to compile the Linux kernel and its modules.
Where can you define the kernel?"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thalheim.io/2022/12/17/hacking-on-kernel-modules-in-nixos/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-17T20:50:21+01:00"><meta property="article:modified_time" content="2022-12-17T20:50:21+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hacking on Kernel Modules in NixOS"><meta name=twitter:description content="Lately, I hacked on some kernel modules to get more debug logs out of a kernel module on my NixOS machine. Because NixOS does not follow the Filesystem Hierarchy Standard (FHS) for filesystem layouts, the standard kernel hacker tutorials won&rsquo;t fully apply to NixOS. However, by leveraging the NixOS configuration, we can quickly set up an environment that allows us to compile the Linux kernel and its modules.
Where can you define the kernel?"><meta itemprop=name content="Hacking on Kernel Modules in NixOS"><meta itemprop=description content="Lately, I hacked on some kernel modules to get more debug logs out of a kernel module on my NixOS machine. Because NixOS does not follow the Filesystem Hierarchy Standard (FHS) for filesystem layouts, the standard kernel hacker tutorials won&rsquo;t fully apply to NixOS. However, by leveraging the NixOS configuration, we can quickly set up an environment that allows us to compile the Linux kernel and its modules.
Where can you define the kernel?"><meta itemprop=datePublished content="2022-12-17T20:50:21+01:00"><meta itemprop=dateModified content="2022-12-17T20:50:21+01:00"><meta itemprop=wordCount content="857"><meta itemprop=keywords content></head><body><header><div id=titletext><h2 id=title><a href=https://blog.thalheim.io/>~/git/blog</a></h2></div><div id=title-description><p id=subtitle>My brain-dump of random code/configuration.</p><div id=social><nav><ul><li><a href=/index.xml rel=me aria-label=RSS><span title=RSS class="icons fas fa-rss" aria-hidden=true></span></a></li><li><a href=https://github.com/Mic92/blog rel=me aria-label=Github><span title=Github class="icons fab fa-github" aria-hidden=true></span></a></li><li><button id=dark-mode aria-label="Switch Dark Mode"><span title="Switch Dark Mode" class="icons fas fa-moon" aria-hidden=true></span></button></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/categories>Categories</a></li></ul></nav></div></header><main><div class=post><article><div class=post-header><div class=meta><div class=date><span class=day>17</span>
<span class=rest>Dec 2022</span></div></div><div class=matter><h1 class=title>Hacking on Kernel Modules in NixOS</h1><p class=post-meta><span class=post-meta><span aria-label=Author:><span class="fas fa-user" aria-hidden=true></span></span>&nbsp;
Jörg Thalheim and Alex A. Renoire</span></p></div></div><div class=markdown><p>Lately, I hacked on some kernel modules to get more debug logs out of a kernel
module on my NixOS machine. Because NixOS does not follow the Filesystem
Hierarchy Standard (FHS) for filesystem layouts, the standard kernel hacker
tutorials won&rsquo;t fully apply to NixOS. However, by leveraging the NixOS
configuration, we can quickly set up an environment that allows us to compile
the Linux kernel and its modules.</p><h1 id=where-can-you-define-the-kernel>Where can you define the kernel?</h1><p>Commonly, Linux distributions put their kernel sources in <code>/usr/src</code> and their
kernel modules in <code>/lib/modules/$(uname -r)</code>. Like always, NixOS is a special
snowflake, but once you get to learn the mechanics, it is actually quite
pleasant to use.</p><p>In the NixOS configuration, the kernel is defined via the <code>boot.kernelPackages</code>
option. The former also defines all out-of-tree kernel modules and other
packages that have the kernel as a build dependency. So, to access the kernel
only, you should look into <code>boot.kernelPackages.kernel</code>.</p><p>Now that you are familiar with the topic, let&rsquo;s proceed to building kernel
modules. This article will guide you through the following steps:</p><ol><li>Setting up a development environment with the necessary tools for building a
kernel</li><li>Building an out-of-tree kernel</li><li>Building an in-tree kernel</li><li>Bonus: Creating a symbolic link to our NixOS configuration flake for easy
reference to the kernel configuration used to build the system.</li></ol><h1 id=getting-the-development-environment>Getting the development environment</h1><p>Let&rsquo;s say you have your NixOS configured in <code>flake.nix</code> like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  inputs<span style=color:#ff79c6>.</span>nixpkgs<span style=color:#ff79c6>.</span>url <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nixpkgs/nixos-unstable-small&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#ff79c6>=</span> { self<span style=color:#ff79c6>,</span> nixpkgs }: {
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      my-nixos <span style=color:#ff79c6>=</span> nixpkgs<span style=color:#ff79c6>.</span>lib<span style=color:#ff79c6>.</span>nixosSystem {
</span></span><span style=display:flex><span>       system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>       modules <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>./configuration.nix</span> ];
</span></span><span style=display:flex><span>     };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let’s assume your NixOS flake is in <code>/etc/nixos</code>. To get a development shell
that has all the required dependencies for building a kernel and kernel modules,
you can run the command below. It will add a C compiler and some libraries
needed for compiling to your shell.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ nix develop &#34;/etc/nixos#nixosConfigurations.my-nixos.config.boot.kernel&#34;
</span></span></code></pre></div><h1 id=lets-build-a-kernel-module-with-that>Let&rsquo;s build a kernel module with that!</h1><p>Apart from the shell, we will also need the kernel development headers to build
a kernel module. They can be found in <code>boot.kernelPackages.kernel.dev</code>.</p><p>Let’s clone an example kernel module and build it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>nix-shell&gt; KERNELDIR=$(nix build --print-out-paths &#34;/etc/nixos/#nixosConfigurations.turingmachine.config.boot.kernelPackages.kernel.dev&#34;)
</span></span><span style=display:flex><span>nix-shell&gt; git clone https://github.com/Mic92/uptime_hack/
</span></span><span style=display:flex><span>nix-shell&gt; cd uptime_hack
</span></span><span style=display:flex><span>nix-shell&gt; make -C $KERNELDIR/lib/modules/*/build M=$(pwd)
</span></span><span style=display:flex><span>make: Entering directory &#39;/nix/store/i7ph759bmlgrlkbz4dj5bjbbq47gx5nw-linux-6.0.12-dev/lib/modules/6.0.12/build&#39;
</span></span><span style=display:flex><span>  CC [M]  /home/joerg/git/uptime_hack/uptime_hack.o
</span></span><span style=display:flex><span>  MODPOST /home/joerg/git/uptime_hack/Module.symvers
</span></span><span style=display:flex><span>  CC [M]  /home/joerg/git/uptime_hack/uptime_hack.mod.o
</span></span><span style=display:flex><span>  LD [M]  /home/joerg/git/uptime_hack/uptime_hack.ko
</span></span><span style=display:flex><span>  BTF [M] /home/joerg/git/uptime_hack/uptime_hack.ko
</span></span><span style=display:flex><span>Skipping BTF generation for /home/joerg/git/uptime_hack/uptime_hack.ko due to unavailability of vmlinux
</span></span><span style=display:flex><span>make: Leaving directory &#39;/nix/store/i7ph759bmlgrlkbz4dj5bjbbq47gx5nw-linux-6.0.12-dev/lib/modules/6.0.12/build&#39;
</span></span></code></pre></div><h1 id=in-of-tree-kernel-modules>In-of-tree kernel modules</h1><p>We can also use this algorithm to build in-tree kernel drivers.</p><p>Next, we’ll need to unpack the current kernel source and copy the kernel
configuration file to our unpacked Linux tree. The current kernel source is
stored in <code>$src</code> in the shell provided by <code>nix develop</code>. We can unpack the
kernel like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ tar -xvf &#34;$src&#34;
</span></span><span style=display:flex><span>$ cd linux-*
</span></span></code></pre></div><p>Then, the Linux kernel configuration is stored in <code>.config</code>. We can copy this
file from the kernel.dev package to our unpacked Linux tree:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ cp $KERNELDIR/lib/modules/*/build/.config .config
</span></span></code></pre></div><p>Next, we will compile the kernel modules. But before, we need to prepare the
build environment for building kernel modules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ make scripts prepare modules_prepare
</span></span></code></pre></div><p>Now, let’s build the new <code>null_blk</code> block device driver like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ make -C . M=drivers/block/null_blk
</span></span></code></pre></div><h1 id=making-your-nixos-closure-refer-the-closure-it-was-build-from>Making your nixos closure refer the closure it was build from</h1><p>If we actually want to insert any of those drivers into the <strong>running</strong> system,
the kernel in the NixOS configuration needs to be the same as the kernel of the
booted system. So, it makes sense to check and compare the kernel versions,
which you can do like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ nix build --print-out-paths &#34;/etc/nixos/#nixosConfigurations.my-nixos.config.boot.kernelPackages.kernel&#34;
</span></span><span style=display:flex><span>/nix/store/yyz5jkjsan9q7v8aa4i7697rrivzwmjz-linux-6.0.12
</span></span><span style=display:flex><span>$ realpath /run/booted-system/kernel
</span></span><span style=display:flex><span>/nix/store/yyz5jkjsan9q7v8aa4i7697rrivzwmjz-linux-6.0.12/bzImage
</span></span></code></pre></div><p>In this case, the paths match because I have not updated my Linux kernel since I
rebooted.</p><p>However, there is an even better way to replace the drivers with the new ones:
by adding a symlink of our NixOS flake to our NixOS system. This way, we will
always be able to refer to the flake at boot time.</p><p>How can you make NixOS closure contain a symlink to its own configuration flake?
By adding extra lines to <code>system.extraSystemBuilderCmds</code> like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  inputs<span style=color:#ff79c6>.</span>nixpkgs<span style=color:#ff79c6>.</span>url <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nixpkgs/nixos-unstable-small&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#ff79c6>=</span> { self<span style=color:#ff79c6>,</span> nixpkgs }: {
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      my-nixos <span style=color:#ff79c6>=</span> nixpkgs<span style=color:#ff79c6>.</span>lib<span style=color:#ff79c6>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        modules <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span>          <span style=color:#f1fa8c>./configuration.nix</span>
</span></span><span style=display:flex><span>          <span style=color:#6272a4># This will add a symlink in your nixos closure</span>
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            system<span style=color:#ff79c6>.</span>extraSystemBuilderCmds <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              ln -s </span><span style=color:#f1fa8c>${</span>self<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> $out/flake
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            &#39;&#39;</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After a reboot, we can check the symlink was added by looking at
<code>/run/booted-system/flake</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ ls -la /run/booted-system/flake
</span></span><span style=display:flex><span>lrwxrwxrwx 2 root root 50 Jan  1  1970 /run/booted-system/flake -&gt; /nix/store/mpqvkfdn46c8b3sd4zcg2fm0y4nsya8v-source
</span></span></code></pre></div><p>Now you can refer to your NixOS configuration like this…</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ nix develop &#34;$(realpath /run/booted-system/flake)#nixosConfigurations.$(hostname).config.boot.kernelPackages.kernel&#34;
</span></span></code></pre></div><p>… and never have to wonder if your system is still in sync with your
configuration.</p><h2 id=conclusion>Conclusion</h2><p>Because things in NixOS are different from what we are used to in regular Linux
distributions, hacking a kernel needs some special attention. In this tutorial,
I shared my experience of hacking the NixOS kernel.</p><p>For quicker iterations on building kernels, also check out the
<a href=https://wiki.nixos.org/wiki/Kernel_Debugging_with_QEMU target=_blank>nixos wiki article</a> that
describes how to debug the Linux kernel with Qemu in NixOS.</p></div><div class=tags><div class=taxosfloating_left><p>Categories</p></div><div class=termsfloating_right><p><a href=/categories/kernel/>kernel</a>
<a href=/categories/nixos/>nixos</a></p></div><div class=clearit></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mic92.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div></main><footer>© 2021 Jörg Thalheim</footer><script src=/js/dark-mode.js></script></body></html>